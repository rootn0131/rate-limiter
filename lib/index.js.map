{"version":3,"sources":["../src/index.js"],"names":["module","exports","options","console","log","param","client","MAXreq","timeRange","req","res","next","ip","zrange","err","reply","lastRequestTimeDelta","Date","now","length","resetTime","parseInt","set","sendStatus","framedRequests","filter","connectionTime","zadd"],"mappings":";;AAAAA,OAAOC,OAAP,GAAkBC,OAAD,IAAa;AAC5BC,UAAQC,GAAR,CAAY,qBAAZ;AACA,QAAM,EAAEC,KAAF,EAASC,MAAT,KAAoBJ,OAA1B;AACA,QAAM,EAAEK,MAAF,EAAUC,SAAV,KAAwBH,KAA9B;AACA,SAAO,CAACI,GAAD,EAAMC,GAAN,EAAWC,IAAX,KAAoB;AACzBR,YAAQC,GAAR,CAAYK,IAAIG,EAAhB;AACAN,WAAOO,MAAP,CAAcJ,IAAIG,EAAlB,EAAsB,CAAtB,EAAyB,CAAC,CAA1B,EAA6B,CAACE,GAAD,EAAMC,KAAN,KAAgB;AAC3C,YAAMC,uBAAuBC,KAAKC,GAAL,KAAaH,MAAMA,MAAMI,MAAN,GAAe,CAAf,GAAmBZ,MAAzB,CAA1C;AACA,YAAMa,YAAY,IAAIH,IAAJ,CAASI,SAASN,MAAMA,MAAMI,MAAN,GAAe,CAArB,CAAT,EAAkC,EAAlC,IAAwCX,YAAY,IAA7D,CAAlB;AACAE,UAAIY,GAAJ,CAAQ,mBAAR,EAA6BF,SAA7B;AACA,UAAIL,MAAMI,MAAN,GAAeZ,MAAf,IAAyBS,wBAAwBR,YAAY,IAAjE,EAAuE;AACrEE,YAAIY,GAAJ,CAAQ,uBAAR,EAAiC,CAAjC;AACAZ,YAAIa,UAAJ,CAAe,GAAf;AACD,OAHD,MAGO;AACL,cAAMC,iBAAiBT,MAAMU,MAAN,CAAaC,kBAAkBA,iBAAiBT,KAAKC,GAAL,KAAaV,YAAY,IAAzE,CAAvB;AACAE,YAAIY,GAAJ,CAAQ,uBAAR,EAAiCf,SAASiB,eAAeL,MAAzD;AACAb,eAAOqB,IAAP,CAAYlB,IAAIG,EAAhB,EAAoBK,KAAKC,GAAL,EAApB,EAAgCD,KAAKC,GAAL,EAAhC;AACAP;AACD;AACF,KAbD;AAcD,GAhBD;AAiBD,CArBD","file":"index.js","sourcesContent":["module.exports = (options) => {\n  console.log('req limiter running');\n  const { param, client } = options;\n  const { MAXreq, timeRange } = param;\n  return (req, res, next) => {\n    console.log(req.ip);\n    client.zrange(req.ip, 0, -1, (err, reply) => {\n      const lastRequestTimeDelta = Date.now() - reply[reply.length - 1 - MAXreq];\n      const resetTime = new Date(parseInt(reply[reply.length - 1], 10) + timeRange * 1000);\n      res.set('X-RateLimit-Reset', resetTime);\n      if (reply.length > MAXreq && lastRequestTimeDelta <= timeRange * 1000) {\n        res.set('X-RateLimit-Remaining', 0);\n        res.sendStatus(429);\n      } else {\n        const framedRequests = reply.filter(connectionTime => connectionTime > Date.now() - timeRange * 1000);\n        res.set('X-RateLimit-Remaining', MAXreq - framedRequests.length);\n        client.zadd(req.ip, Date.now(), Date.now());\n        next();\n      }\n    });\n  };\n};\n"]}